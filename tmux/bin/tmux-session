#!/usr/bin/env bash
# Save and restore tmux sessions, windows, panes, and layouts.
set -euo pipefail

TAB=$'\t'
STATE_FILE_DEFAULT="$HOME/.local/share/tmux/sessions/latest"

state_file() {
  printf "%s\n" "${TMUX_SESSION_FILE:-$STATE_FILE_DEFAULT}"
}

usage() {
  cat <<'EOF'
Usage: tmux-session [save|restore|path]

  save     Persist every tmux session/window/pane layout to disk
  restore  Recreate tmux sessions from the last saved state
  path     Print the file tmux-session uses for persistence

Set TMUX_SESSION_FILE to override the default state file location.
EOF
}

require_tmux_server() {
  if ! command -v tmux >/dev/null 2>&1; then
    echo "tmux-session: tmux is not installed or not on PATH" >&2
    exit 1
  fi
}

require_active_sessions() {
  if ! tmux list-sessions >/dev/null 2>&1; then
    echo "tmux-session: no running tmux server to snapshot" >&2
    exit 1
  fi
}

dump() {
  tmux list-panes -a -F "#S${TAB}#I${TAB}#W${TAB}#P${TAB}#{window_layout}${TAB}#{pane_active}${TAB}#{pane_current_path}"
}

save() {
  require_tmux_server
  require_active_sessions

  local file
  file="$(state_file)"
  mkdir -p "$(dirname "$file")"

  dump | LC_ALL=C sort -t"$TAB" -k1,1 -k2,2n -k4,4n > "$file"

  local sessions
  sessions=$(cut -f1 "$file" | LC_ALL=C sort -u | wc -l | awk '{print $1}')
  echo "tmux-session: saved ${sessions} session(s) to ${file}"
}

session_exists() {
  tmux has-session -t "$1" 2>/dev/null
}

add_window() {
  local session="$1"
  local window_name="$2"
  local dir="$3"
  local index="${4:-}"

  if [[ -n "$index" ]]; then
    tmux new-window -d -t "${session}:${index}" -n "$window_name" -c "$dir"
  else
    tmux new-window -d -t "${session}:" -n "$window_name" -c "$dir"
  fi
}

new_session() {
  local session="$1"
  local window_name="$2"
  local dir="$3"

  ( cd "$dir" && tmux new-session -d -s "$session" -n "$window_name" )
}

restore() {
  require_tmux_server

  local file
  file="$(state_file)"

  if [[ ! -s "$file" ]]; then
    echo "tmux-session: nothing to restore (missing or empty state file: $file)" >&2
    exit 1
  fi

  tmux start-server

  declare -A windows_created
  declare -A window_layouts
  declare -A active_panes
  declare -A active_windows

  local restored_windows=0
  local restored_sessions=0

  while IFS=$'\t' read -r session window_index window_name pane_index layout pane_active pane_path; do
    [[ -n "$session" ]] || continue

    local window_key="${session}:${window_index}"
    local dir="$pane_path"
    [[ -d "$dir" ]] || dir="$HOME"

    if [[ -z "${windows_created[$window_key]:-}" ]]; then
      if session_exists "$session"; then
        add_window "$session" "$window_name" "$dir" "$window_index"
      else
        new_session "$session" "$window_name" "$dir"
        ((restored_sessions+=1))
        if [[ "$window_index" =~ ^[0-9]+$ && "$window_index" -ne 0 ]]; then
          tmux move-window -s "${session}:0" -t "${session}:${window_index}" >/dev/null 2>&1 || true
        fi
      fi

      windows_created["$window_key"]=1
      ((restored_windows+=1))
    else
      tmux split-window -d -t "${session}:${window_index}" -c "$dir"
    fi

    window_layouts["$window_key"]="$layout"

    if [[ "$pane_active" == "1" ]]; then
      active_panes["$window_key"]="${session}:${window_index}.${pane_index}"
      active_windows["$session"]="$window_index"
    fi
  done < "$file"

  for key in "${!window_layouts[@]}"; do
    tmux select-layout -t "$key" "${window_layouts[$key]}" >/dev/null 2>&1 || true
  done

  for key in "${!active_panes[@]}"; do
    tmux select-pane -t "${active_panes[$key]}" >/dev/null 2>&1 || true
  done

  for session in "${!active_windows[@]}"; do
    tmux select-window -t "${session}:${active_windows[$session]}" >/dev/null 2>&1 || true
  done

  echo "tmux-session: restored ${restored_sessions} session(s) and ${restored_windows} window(s)"
}

case "${1:-}" in
  save|restore )
    "$1"
    ;;
  path )
    state_file
    ;;
  ""|-h|--help )
    usage
    ;;
  * )
    usage >&2
    exit 1
    ;;
esac
